<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  body { font-family: 'Poppins', sans-serif; background-color: #1a1424; color: white; scroll-behavior: smooth; }
  .btn { background-color: #D4AF37; color: black; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; display: inline-block; text-align: center; }
  .btn:hover { transform: scale(1.05); box-shadow: 0 0 20px #D4AF37; }
  .video-slide { max-width: 100%; border-radius: 0.5rem; box-shadow: 0 0 20px #000; }
  .discount-badge { background-color: #ff4d6d; color: white; padding: 0.2rem 0.5rem; font-size: 0.8rem; border-radius: 0.3rem; margin-left: 0.5rem; }
  .faq-question { font-weight: bold; margin-top: 1rem; }
  .footer-links a { color: #D4AF37; text-decoration: underline; }
</style>
</head>
<body><section id="signup" class="py-16 max-w-md mx-auto px-6">
  <h2 class="text-3xl font-bold text-center text-[#D4AF37] mb-8">Sign Up / Login</h2>
  <div class="bg-[#3D2C41] p-8 rounded-xl shadow-lg">
    <input type="email" id="email" placeholder="Email" class="w-full p-3 mb-4 rounded text-black">
    <input type="password" id="password" placeholder="Password" class="w-full p-3 mb-4 rounded text-black">
    <button id="signup-btn" class="btn w-full mb-2">Sign Up</button>
    <button id="login-btn" class="btn w-full mb-2">Login</button>
    <button id="google-login" class="btn w-full mb-2">Sign In with Google</button>
    <p class="mt-2 text-sm text-center text-[#D4AF37]">Forgot password? <a href="#">Reset here</a></p>
    <p class="mt-2 text-sm text-center text-[#ff4d6d]">Support: keishapoa@gmail.com</p>
  </div>
</section>
<!-- Place this at the bottom, just before </body> -->
<section id="video-tool" class="py-16 bg-[#2b1f38]">
  <div class="max-w-6xl mx-auto px-6">
    <h2 class="text-4xl font-bold text-center text-[#D4AF37] mb-12">Video Creation Tool</h2>

    <!-- Prompt Input -->
    <div class="mb-6">
      <label class="block text-lg font-semibold mb-2">Enter Your Prompt</label>
      <textarea id="prompt-input" class="w-full p-4 rounded-lg bg-[#3D2C41] text-white" rows="3" placeholder="Describe your scene..."></textarea>
      <div class="flex flex-wrap mt-2 gap-2">
        <button onclick="setPrompt('Funny')" class="btn">Funny</button>
        <button onclick="setPrompt('Cinematic')" class="btn">Cinematic</button>
        <button onclick="setPrompt('Fantasy')" class="btn">Fantasy</button>
        <button onclick="applyTemplate('Ultra-Cinematic')" class="btn">Cinematic Template</button>
        <button onclick="refinePrompt()" class="btn">Prompt Magic</button>
      </div>
    </div>

    <!-- Upload Photos -->
    <div class="mb-6">
      <label class="block text-lg font-semibold mb-2">Upload Photos (Photo-to-Video)</label>
      <input type="file" id="photo-upload" class="w-full p-2 rounded-lg bg-[#3D2C41] text-white" multiple accept="image/png, image/jpeg">
    </div>

    <!-- Watermark / Logo -->
    <div class="mb-6">
      <label class="block font-semibold mb-1">Watermark / Logo (Paid Users)</label>
      <input type="file" id="watermark-upload" class="w-full p-2 rounded-lg bg-[#3D2C41] text-white" accept="image/png, image/jpeg">
    </div>

    <!-- Audio Overlay -->
    <div class="mb-6">
      <label class="block font-semibold mb-1">Audio Overlay (Optional)</label>
      <select id="audio-select" class="w-full p-2 rounded-lg bg-[#3D2C41] text-white">
        <option value="None">None</option>
        <option value="Epic Music">Epic Music</option>
        <option value="Ambient">Ambient</option>
        <option value="Cinematic Voice">Cinematic Voice</option>
      </select>
    </div>

    <!-- Video Options -->
    <div class="mb-6 grid md:grid-cols-3 gap-4">
      <div>
        <label class="block font-semibold mb-1">Model</label>
        <select id="model-select" class="w-full p-2 rounded-lg bg-[#3D2C41] text-white">
          <option>Hyper-realistic</option>
          <option>Cinematic</option>
          <option>Fantasy</option>
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-1">Resolution</label>
        <select id="resolution-select" class="w-full p-2 rounded-lg bg-[#3D2C41] text-white">
          <option>720p</option>
          <option>1080p</option>
          <option>4K</option>
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-1">Length</label>
        <select id="length-select" class="w-full p-2 rounded-lg bg-[#3D2C41] text-white">
          <option>6 sec (Free)</option>
          <option>30 sec</option>
          <option>1 min</option>
        </select>
      </div>
    </div>

    <!-- Generate / Clear Buttons -->
    <div class="flex flex-wrap gap-4 mb-6">
      <button onclick="generateVideo(currentUser)" class="btn">Generate Video</button>
      <button onclick="clearVideo()" class="btn bg-red-600 hover:bg-red-700">Clear / Reset</button>
    </div>

    <!-- Loading, Batch & Video Preview -->
    <div id="video-preview" class="mt-6 text-center">
      <p id="loading-text" class="mb-2 hidden">Generating your video, please wait...</p>
      <p id="batch-progress" class="mb-2 hidden">Batch: <span id="current-batch">0</span> / <span id="total-batch">0</span></p>
      <video id="generated-video" class="mx-auto rounded-lg shadow-lg" controls style="max-width:100%; display:none;"></video>
      <div class="mt-2">
        <button id="regenerate-btn" class="btn mb-2 hidden" onclick="generateVideo(currentUser)">Regenerate</button>
        <button id="download-btn" class="btn mb-2 hidden">Download</button>
      </div>
      <div id="error-message" class="text-red-500 mt-2 font-semibold text-center"></div>
    </div>
  </div>
</section>

<script>
let currentUser = null; // Replace with your Firebase Auth user

function setPrompt(category) {
  document.getElementById('prompt-input').value = category + ' prompt example...';
}
function refinePrompt() {
  const input = document.getElementById('prompt-input');
  input.value = "Refined: " + input.value;
}
function applyTemplate(template) {
  document.getElementById('prompt-input').value = template + " cinematic template applied...";
}
function clearVideo() {
  document.getElementById('generated-video').style.display = "none";
  document.getElementById('regenerate-btn').classList.add('hidden');
  document.getElementById('download-btn').classList.add('hidden');
  document.getElementById('prompt-input').value = '';
  document.getElementById('photo-upload').value = '';
  document.getElementById('watermark-upload').value = '';
  document.getElementById('audio-select').value = 'None';
  document.getElementById('error-message').innerText = '';
}
function showError(message) {
  document.getElementById('error-message').innerText = message;
}
function clearError() {
  showError('');
}

async function generateVideo(user) {
  try {
    if(!user) {
      showError('❌ Please sign in first.');
      return;
    }

    const prompt = document.getElementById('prompt-input').value;
    const photos = document.getElementById('photo-upload').files;
    const model = document.getElementById('model-select').value;
    const resolution = document.getElementById('resolution-select').value;
    const length = document.getElementById('length-select').value;
    const watermark = document.getElementById('watermark-upload').files[0];
    const audio = document.getElementById('audio-select').value;

    if(!prompt && photos.length === 0) {
      showError('❌ Enter a prompt or upload at least one photo.');
      return;
    }

    clearError();
    document.getElementById('loading-text').classList.remove('hidden');
    document.getElementById('generated-video').style.display = 'none';
    document.getElementById('batch-progress').classList.remove('hidden');

    // Determine batch count
    const batchCount = (user.plan === 'pro' || user.plan === 'diamond') ? Math.max(photos.length,1) : 1;
    document.getElementById('total-batch').innerText = batchCount;

    for(let i=0; i<batchCount; i++){
      document.getElementById('current-batch').innerText = i+1;

      // ----- Replace with your AI backend call -----
      await new Promise(resolve => setTimeout(resolve, 1500)); // simulate generation delay
      const videoEl = document.getElementById('generated-video');
      videoEl.src = "https://streamable.com/e/6psp7n"; // example placeholder
      videoEl.style.display = 'block';
      document.getElementById('regenerate-btn').classList.remove('hidden');
      document.getElementById('download-btn').classList.remove('hidden');
    }

    document.getElementById('batch-progress').classList.add('hidden');

  } catch(err) {
    showError('❌ Video generation failed. Try again.');
  } finally {
    document.getElementById('loading-text').classList.add('hidden');
  }
}
</script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously, createUserWithEmailAndPassword, linkWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

// init app (use your firebaseConfig)
const firebaseConfig = { /* your config */ };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ensure anonymous sign-in on page load
async function ensureAnonymousUser(){
  return new Promise((resolve, reject) => {
    onAuthStateChanged(auth, async (user) => {
      if(user){
        // user exists (anonymous or real)
        resolve(user);
      } else {
        try {
          const anon = await signInAnonymously(auth);
          resolve(anon.user);
        } catch(e) {
          reject(e);
        }
      }
    });
  });
}

// helper: get or create user doc with plan + videoCount
async function ensureUserDoc(uid){
  const uRef = doc(db, 'users', uid);
  const snap = await getDoc(uRef);
  if(!snap.exists()){
    await setDoc(uRef, { plan: 'free', videoCount: 0, createdAt: new Date().toISOString() });
    return { plan: 'free', videoCount: 0 };
  }
  return snap.data();
}

// call at app start
let currentUser = null;
await ensureAnonymousUser().then(async (user)=>{
  currentUser = user;
  // ensure user doc exists
  await ensureUserDoc(user.uid);
  console.log('Signed in as', user.uid, 'isAnonymous=', user.isAnonymous);
}).catch(err=>{
  console.error('Anon sign-in failed', err);
});
// call when user signs up (provide email/password from your signup modal)
async function convertAnonToEmail(email, password){
  const credential = EmailAuthProvider.credential(email, password);
  try {
    const linked = await linkWithCredential(auth.currentUser, credential);
    // now auth.currentUser is the real email user; their uid remains same
    // update Firestore user doc plan => 'pro' etc
    await updateDoc(doc(db,'users', auth.currentUser.uid), { plan: 'pro' });
    showSuccess('Account created & linked. Enjoy Pro features');
  } catch(err){
    // handle error (e.g., email already in use)
    showError('Could not create account: ' + err.message);
  }
}
